"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function a(e){try{u(n.next(e))}catch(e){o(e)}}function s(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(a,s)}u((n=n.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function r(e){return function(t){return n([e,t])}}function n(r){if(i)throw new TypeError("Generator is already executing.");for(;u;)try{if(i=1,o&&(a=2&r[0]?o.return:r[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,r[1])).done)return a;switch(o=0,a&&(r=[2&r[0],a.value]),r[0]){case 0:case 1:a=r;break;case 4:return u.label++,{value:r[1],done:!1};case 5:u.label++,o=r[1],r=[0];continue;case 7:r=u.ops.pop(),u.trys.pop();continue;default:if(a=u.trys,!(a=a.length>0&&a[a.length-1])&&(6===r[0]||2===r[0])){u=0;continue}if(3===r[0]&&(!a||r[1]>a[0]&&r[1]<a[3])){u.label=r[1];break}if(6===r[0]&&u.label<a[1]){u.label=a[1],a=r;break}if(a&&u.label<a[2]){u.label=a[2],u.ops.push(r);break}a[2]&&u.ops.pop(),u.trys.pop();continue}r=t.call(e,u)}catch(e){r=[6,e],o=0}finally{i=a=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}var i,o,a,s,u={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};define("ExploreActions/services/drillthrough",["require","exports"],function(e,t){function r(e){for(var t=[],r=0,n=e;r<n.length;r++){var i=n[r];if(i.dataMap)for(var o in i.dataMap)for(var a=0,s=i.dataMap[o];a<s.length;a++){var u=s[a],l=u;if(l){var c=l.expr;if(c){var f=d.getInExpr(c);t.push(f)}}}}return t}function n(e,t,r){for(var n=[],i=w.getVisualQuery(t),o=0,a=e;o<a.length;o++){var s=a[o];if(s.metadata)for(var u=0,l=s.metadata;u<l.length;u++){var c=l[u],f=i.defn.select().withName(c);if(f&&f.expr){var h=x.asFieldPattern(f.expr,r),d=p.getBaseSQExpr(h,r);n.push(d)}}}return n}function i(e,t,r,n){return{targetName:e.section.name,actionDisplayName:e.section.displayName,getFilterContext:function(){return o(e,t,r,n)}}}function o(e,t,r,n){for(var i=[],o=[],a=0,s=e.matchedLinkFields;a<s.length;a++){var u=s[a],l=u.fieldExpr;if(!u.asAggregation&&!g.isMeasure(l)){for(var c=l.getKeyColumns(n),f=[],p=[],d=function(e){var r=_.findIndex(t,function(t){return g.equals(t.column,e)});o.push(r),f.push(t[r].column),p.push(t[r].value)},x=0,y=c;x<y.length;x++){d(y[x])}var S=v.fromSQExpr(m.inValues(f,[p]));i.push({filterExpressionMetadata:{expressions:[l]},filter:S,isTransient:!1})}}if(e.section.acceptsAllFiltersWhenLinked||h.hasMeasureOrAsAggregationLinkField(e.section)){if(!_.isEmpty(r)){var w=h.getFiltersToApplyFromVisualQueryFilterContext(r);_.remove(w,function(e){return 2===e.scope});for(var E=0,b=w;E<b.length;E++){var F=b[E];i.push({filter:F.filter,isTransient:!0,filterExpressionMetadata:F.filterExpressionMetadata,restatement:F.restatement,type:F.type})}}for(var M=function(e){if(_.includes(o,e))return"continue";var r=t[e],n=v.fromSQExpr(m.compare(0,r.column,r.value));return _.find(i,function(e){return v.isSameFilter(e.filter,n)})?"continue":void i.push({filterExpressionMetadata:{expressions:[r.column]},filter:n,isTransient:!0})},A=0;A<t.length;A++)M(A)}return i}function a(e,t,r,n,i,o){var a=[];if(o||1!==n)for(var u=_.filter(e.filters,function(e){return 5===e.howCreated&&!e.isTransient}),l=0,c=u;l<c.length;l++){var f=c[l];a.push(s(f))}else a=e.linkFields;if(!_.isEmpty(a)){for(var p=[],h=function(e){var n=e.fieldExpr;if(!n)return"continue";if(g.isMeasure(n)){_.find(r,function(e){return g.isMeasure(e)&&g.equals(e,n)})&&p.push(e)}else{var o=n.getKeyColumns(i);if(!_.isEmpty(o))if(e.asAggregation)for(var a=0,s=r;a<s.length;a++){var u=s[a];if(g.isAggregation(u)){var l=u.arg.getKeyColumns(i);if(y.isSubset(o,l)){p.push(e);break}}}else y.isSubset(o,t)&&p.push(e)}},d=0,v=a;d<v.length;d++){h(v[d])}return _.isEmpty(p)?void 0:{section:e,matchedLinkFields:p}}}function s(e){return{asAggregation:!!e.isLinkedAsAggregation,fieldExpr:e.expression}}function u(e){if(e){for(var t=[],r=function(e){e&&!_.isEmpty(e.args)&&1===e.values.length&&_.every(e.args,function(r,n){return t.push({column:r,value:e.values[0][n]})})},n=0,i=e;n<i.length;n++){r(i[n])}return t}}function l(e,t,r,n){return new E(e,t,r,n)}Object.defineProperty(t,"__esModule",{value:!0});var c=powerbi.data,f=powerbi.requireSync,p=c.FieldExprPattern,h=powerbi.explore.FilterUtils,d=powerbi.data.ScopeIdentityExtractor,v=c.SemanticFilter,g=c.SQExpr,m=c.SQExprBuilder,x=powerbi.data.SQExprConverter,y=c.SQExprUtils,S=jsCommon.StringExtensions,w=powerbi.explore.util.VisualContainerUtils,E=function(){function e(e,t,r,n){this.conceptualSchemaProxy=e,this.featureSwitchService=t,this.dataSources=r,this.explorationNavigationService=n}return e.prototype.getMatchedSectionsInfo=function(e,t,r,n,i){return __awaiter(this,void 0,powerbi.Promise,function(){var o;return __generator(this,function(a){switch(a.label){case 0:return[4,this.getMatchedSectionAndDrillthroughActionPairs(e,void 0,t,r,n,i)];case 1:return o=a.sent(),[2,_.map(o,function(e){return _.extend(e.sectionInfo,{getFilterContext:e.action.getFilterContext})})]}})})},e.prototype.getForcedMatchSectionInfo=function(e,t,r,n,i,o){return __awaiter(this,void 0,powerbi.Promise,function(){var a,s,u;return __generator(this,function(l){switch(l.label){case 0:return[4,this.getMatchedSectionAndDrillthroughActionPairs(e,t,r,n,i,o)];case 1:return a=l.sent(),s=_.size(a),s<1?[2]:(u=a[0],[2,_.extend(u.sectionInfo,{getFilterContext:u.action.getFilterContext})])}})})},e.prototype.getDrillthroughActions=function(e,t,r,n){return __awaiter(this,void 0,powerbi.Promise,function(){var i;return __generator(this,function(o){switch(o.label){case 0:return[4,this.getMatchedSectionAndDrillthroughActionPairs(0,void 0,e,t,r,n)];case 1:return i=o.sent(),[2,_.map(i,function(e){return e.action})]}})})},e.prototype.getMatchedSectionAndDrillthroughActionPairs=function(e,t,o,a,s,l){return __awaiter(this,void 0,powerbi.Promise,function(){var c,f,p,h,d,v,g,m,x,y;return __generator(this,function(S){switch(S.label){case 0:return 1!==_.size(s)?[2]:(c=r(s),f=u(c),0===_.size(f)&&0!==_.size(c)?[2]:(p=[],[4,this.conceptualSchemaProxy.get(this.dataSources.get())]));case 1:if(h=S.sent(),(1===e||this.featureSwitchService.featureSwitches.measureDrillthrough)&&(p=n(s,a,h)),d=this.getMatchedSectionsInfoImpl(e,t,o,a,f,p,h),_.isEmpty(d))return[2];for(v=[],g=0,m=d;g<m.length;g++)x=m[g],y=i(x,f,l,h),v.push({sectionInfo:x,action:y});return[2,v]}})})},e.prototype.getApplyStateInfo=function(e,t){void 0===t&&(t=!0);var r,n=this.explorationNavigationService.getAllSections(),i=_.find(n,function(t){return t.name===e.targetName});if(i){for(var o=[],a=e.getFilterContext().slice(),s=function(e){if(5!==e.howCreated||e.isTransient)return"continue";var t=_.find(a,function(t){return!t.isTransient&&t.filterExpressionMetadata&&g.equals(t.filterExpressionMetadata.expressions[0],e.expression)}),r=f("Explore/services/explorationState").convertToFilterContainerState(e);t?(_.remove(a,t),r.filter=t.filter,r.cachedValueItems=void 0):(r.filter=void 0,r.cachedValueItems=void 0),o.push(r)},u=0,l=i.filters;u<l.length;u++){s(l[u])}var c={exprIdentifiedMerges:o};if(_.some(a,function(e){return e.isTransient})){for(var p=[],h={},d=0,v=i.filters;d<v.length;d++){h[v[d].name]=!0}for(var m=0,x=a;m<x.length;m++){var y=x[m],w=S.findUniqueName(h,"transientFilter");h[w]=!0;var E={name:w,expression:_.isEmpty(y.filterExpressionMetadata)?void 0:y.filterExpressionMetadata.expressions[0],type:y.type,restatement:y.restatement,filter:y.filter,howCreated:5,isTransient:!0};p.push(E)}c.transientFilters=p}return{state:{activeSection:t?i.name:void 0,sections:(r={},r[i.name]={filters:c},r)},options:{clearUnmatchedData:!1,suppressActiveSection:!t}}}},e.prototype.getMatchedSectionsInfoImpl=function(e,t,r,n,i,o,s){if(!_.isEmpty(i)||!_.isEmpty(o)){var u,l=this.featureSwitchService.featureSwitches.measureDrillthrough,c=this.explorationNavigationService.getAllSections(),f=function(e){return _.isEmpty(t)||e.name===t},p=function(t){return t.type===e||0===e&&null==t.type};if(u=_.filter(c,function(e){return e.name!==r&&f(e)&&p(e)}),u=l||1!==e?_.filter(u,function(e){return!_.isEmpty(t)||_.some(e.filters,function(e){return 5===e.howCreated&&!e.isTransient})}):_.filter(u,function(e){return!_.isEmpty(t)||!_.isEmpty(e.linkFields)}),!_.isEmpty(u)){for(var h=[],d=_.map(i,function(e){return e.column}),v=0,g=u;v<g.length;v++){var m=g[v],x=a(m,d,o,e,s,l);x&&h.push(x)}return!_.isEmpty(t)&&_.isEmpty(h)&&h.push({section:_.find(c,function(e){return e.name===t}),matchedLinkFields:[]}),h}}},e}();t.create=l}),angular.module("powerbi.explore.actions",["powerbi.explore","powerbi.common"]);