"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))(function(a,n){function o(e){try{s(i.next(e))}catch(e){n(e)}}function l(e){try{s(i.throw(e))}catch(e){n(e)}}function s(e){e.done?a(e.value):new r(function(t){t(e.value)}).then(o,l)}s((i=i.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function r(e){return function(t){return i([e,t])}}function i(r){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,n&&(o=2&r[0]?n.return:r[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,r[1])).done)return o;switch(n=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,n=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(o=s.trys,!(o=o.length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=t.call(e,s)}catch(e){r=[6,e],n=0}finally{a=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}var a,n,o,l,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return l={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l},__extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),powerbi;!function(e){var t;!function(e){var t;!function(e){var t;!function(e){e.NotIn="NotIn",e.SelectAll="All",e.operatorDictionary={None:0,LessThan:1,LessThanOrEqual:2,GreaterThan:3,GreaterThanOrEqual:4,Contains:5,DoesNotContain:6,StartsWith:7,DoesNotStartWith:8,Is:9,IsNot:10,IsBlank:11,IsNotBlank:12},e.logicalOperatorDictionary={Or:1,And:0};var t;!function(e){e.InvalidDataType="InvalidDataType",e.FieldNotFound="FieldNotFound",e.FilterConditionNotFound="FilterConditionNotFound",e.FilterValidationErrors="FilterValidationErrors",e.LogicalConditionNotFound="LogicalConditionNotFound",e.BasicFilterSerializationError="BasicFilterSerializationError",e.TupleFilterSerializationError="TupleFilterSerializationError",e.AdvancedFilterSerializationError="AdvancedFilterSerializationError",e.InvalidFilterType="InvalidFilterType",e.InvalidFilterCondition="InvalidFilterCondition",e.FilterNotFound="FilterNotFound",e.BasicFilterOperatorNotFound="BasicFilterOperatorNotFound",e.InvalidReportData="InvalidReportData",e.InvalidPageData="InvalidPageData"}(t=e.ErrorCodes||(e.ErrorCodes={}));var r;!function(e){e.InvalidFilterMessage="Filter is not valid, validation errors: ",e.InvalidTarget="Could not serialize json filter target to SQ expression.",e.InvalidCondition="Advanced filter requires a filter condition (None | LessThan | LessThanOrEqual | GreaterThan | GreaterThanOrEqual | Contains | DoesNotContain | StartsWith | DoesNotStartWith | Is | IsNot | IsBlank | IsNotBlank).",e.InvalidDataTypeMessage="The data type of the value {0} is not supported. Only string, number and boolean are supported.",e.FilterSerializationError="Could not serialize filter.",e.InvalidFilterTypeMessage="Not supported filter type - can't serialize to json syntax.",e.SemanticFilterInvalidCondition="Filter with invalid condition - can't serialize to json syntax.",e.FilterNotFoundMessage="Invoked filter serialization function with no filter.",e.FieldNotFoundMessage="Invoked filter serialization function on a table that has no column/measure/hierarchy.",e.BasicFilterOperatorNotFoundMessage="Basic filter requires an operator (In | Not).",e.FilterValuesNotFound=" Could not retrieve filter values.",e.InvalidReportDataMessage="Could not find the report.",e.InvalidPageDataMessage="Could not find the active page.",e.DataPointSerializationError="Could not serialize a data point.",e.TupleFilterSerializationError="Could not serialize Tuple filter."}(r=e.ErrorMessages||(e.ErrorMessages={}))}(t=e.constants||(e.constants={}))}(t=e.jsonFilter||(e.jsonFilter={}))}(t=e.explore||(e.explore={}))}(powerbi||(powerbi={}));var powerbi;!function(e){var t;!function(t){var r;!function(i){function a(e){return"name"in e}function n(e){return"visualName"in e&&"pageName"in e}function o(t,r,i){return __awaiter(this,void 0,e.Promise,function(){var e;return __generator(this,function(a){switch(a.label){case 0:return[4,r.require({javascript:"powerbi-models"})];case 1:return e=a.sent(),[2,new d(t,e,i)]}})})}var l=r.constants,s=e.data.SemanticFilter,u=e.data.SQExprBuilder,c=jsCommon.Trace,p=jsCommon.Utility;i.instanceOfIPageLevel=a,i.instanceOfIVisualLevel=n,i.createJSONFilterParserService=o;var d=function(){function r(e,t,r){this.promiseFactory=e,this.PowerBIModels=t,this.telemetryService=r,this.fieldVisitor=new i.JsonFilterBuilder.SemanticFilterFieldVisitor}return r.prototype.tryCreateFilterContainer=function(e,t,r){try{return this.constructFilterContainer(e,t,r)}catch(e){return v.traceError(e),null}},r.prototype.tryConvertJsonFilterArrayToSemanticFilter=function(e,t){try{return this.convertJsonFilterArrayToSemanticFilter(e,t)}catch(e){v.traceError(e)}return null},r.prototype.tryGetFilters=function(e,t){var r=this,a=[];if(!e.filters||0===e.filters.length)return this.promiseFactory.resolve(a);try{a=e.filters.map(function(e){return i.JsonFilterBuilder.fromSemanticFilter(e,t,e.filter,r.PowerBIModels,r.telemetryService)})}catch(e){return v.traceError(e),void 0!==e.message?this.promiseFactory.reject({message:e.message}):this.promiseFactory.reject({message:l.ErrorMessages.FilterSerializationError})}return this.promiseFactory.resolve(a)},r.prototype.tryGetSelectedDataPoints=function(e,t,r,i,a){var n=this;if(!i||!i.config||!i.config.singleVisual)return this.promiseFactory.reject({message:l.ErrorMessages.DataPointSerializationError});var o,s=i.config.singleVisual,u=this.promiseFactory.defer();return this.tryGetFilters(i,t).then(function(c){try{o={report:n.getReportInfo(e),page:n.getActivePageInfo(e),visual:n.getVisualInfo(i.name,a,s.visualType),dataPoints:n.getDataPoints(r,t),regions:null,filters:c},u.resolve(o)}catch(e){v.traceError(e),void 0!==e.message?u.reject({message:e.message}):u.reject({message:l.ErrorMessages.DataPointSerializationError})}}).catch(function(e){u.reject(e)}),u.promise},r.prototype.getValues=function(e,t){var r=this,i=[];return e?_.map(e,function(e){return{target:r.getSelectedValueTarget(e.expr,t),value:e.value,formattedValue:e.formattedValue}}):i},r.prototype.getSelectedValueTarget=function(t,r){var i=e.data.SQExprConverter.asFieldPattern(t,r);if(!i)return null;var a;if(i.columnAggr||i.groupingColumnAggr){var n=i.columnAggr||i.groupingColumnAggr;a={table:n.entity,column:n.name,aggregationFunction:e.data.aggregateFunctionName(n.aggregate)}}else if(i.hierarchyLevelAggr){var o=i.hierarchyLevelAggr;a={table:o.entity,hierarchy:o.name,hierarchyLevel:o.level,aggregationFunction:e.data.aggregateFunctionName(o.aggregate)}}else if(i.measure){var l=i.measure;a={table:l.entity,measure:l.name}}else if(i.column){var s=i.column;a={table:s.entity,column:s.name}}return a},r.prototype.getDataPoints=function(t,r){var i=[];if(_.isEmpty(t))return i;for(var a=0,n=t;a<n.length;a++){var o=n[a],l={identity:[],values:this.getValues(o.values,r)},s=o.selector.data;if(s)for(var u=0,c=s;u<c.length;u++){var p=c[u];if(p.expr){var d=p,v=e.data.SQExprConverter.getAllComparands(d);if(!v)return i;for(var f=0,F=v;f<F.length;f++){var g=F[f],y=g.expr.accept(this.fieldVisitor);l.identity.push({target:y,equals:g.value})}}}i.push(l)}return i},r.prototype.getReportInfo=function(e){return e&&null!=e.activeSectionIndex||p.throwException(v.invalidReportData()),{id:e.report.objectId,displayName:e.report.displayName}},r.prototype.getActivePageInfo=function(e){e&&null!=e.activeSectionIndex||p.throwException(v.invalidPageData());var t=e.sections[e.activeSectionIndex];return{name:t.name,displayName:t.displayName}},r.prototype.getVisualInfo=function(e,t,r){var i={name:e,type:r};return t&&(i.title=t),i},r.prototype.constructFilterContainer=function(e,t,r){var i,a=this.validateFilter(r);if(a)p.throwException(v.filterValidationErrors(a));else{var n=this.PowerBIModels.getFilterType(r);n===this.PowerBIModels.FilterType.Basic?i=this.buildBasicFilterContainer(e,r,t):n===this.PowerBIModels.FilterType.Advanced?i=this.buildAdvancedFilterContainer(e,t,r):n===this.PowerBIModels.FilterType.RelativeDate&&(i=this.buildRelativeDateFilterContainer(e,r,t))}return i},r.prototype.createRelativeDateFilterParameters=function(e,t){var r=this.getFieldExpr(e.target,t);return r||p.throwException(v.fieldNotFound(e.target)),{field:r,options:{duration:e.timeUnitsCount,includeToday:e.includeToday,relativeQualifier:this.translateToRelativeDateQualifierEnum(e.operator),relativeUnit:this.translateToRelativeDateUnitEnum(e.timeUnitType)}}},r.prototype.translateToRelativeDateUnitEnum=function(t){switch(t){case this.PowerBIModels.RelativeDateFilterTimeUnit.Days:return e.data.RelativeDateUnit.Day;case this.PowerBIModels.RelativeDateFilterTimeUnit.Weeks:return e.data.RelativeDateUnit.Week;case this.PowerBIModels.RelativeDateFilterTimeUnit.CalendarWeeks:return e.data.RelativeDateUnit.CalendarWeek;case this.PowerBIModels.RelativeDateFilterTimeUnit.Months:return e.data.RelativeDateUnit.Month;case this.PowerBIModels.RelativeDateFilterTimeUnit.CalendarMonths:return e.data.RelativeDateUnit.CalendarMonth;case this.PowerBIModels.RelativeDateFilterTimeUnit.Years:return e.data.RelativeDateUnit.Year;case this.PowerBIModels.RelativeDateFilterTimeUnit.CalendarYears:return e.data.RelativeDateUnit.CalendarYear;default:return}},r.prototype.translateToRelativeDateQualifierEnum=function(t){switch(t){case this.PowerBIModels.RelativeDateOperators.InLast:return e.data.RelativeDateQualifier.Last;case this.PowerBIModels.RelativeDateOperators.InThis:return e.data.RelativeDateQualifier.Current;case this.PowerBIModels.RelativeDateOperators.InNext:return e.data.RelativeDateQualifier.Next;default:return}},r.prototype.buildRelativeDateFilterContainer=function(r,i,a){var n=e.data.RelativeDateFilterPattern.buildSemanticFilter(this.createRelativeDateFilterParameters(i,a));return{name:t.FilterUtils.getNextFilterName(r.filters),expression:this.getFieldExpr(i.target,a),filter:n,type:e.explore.contracts.FilterType.RelativeDate}},r.prototype.getTupleElementTargetExpressions=function(e,t){var r=this.getFieldExpr(e,t);r||p.throwException(v.fieldNotFound(e));var i=this.getFieldExprsForKeys(e,t);return i?i:[r]},r.prototype.getTupleTargetExpressions=function(e,t){for(var r=[],i=0,a=e;i<a.length;i++){var n=a[i];r=r.concat(this.getTupleElementTargetExpressions(n,t))}return r},r.prototype.getTupleElementValueExpressions=function(e){var t=[];if(e.keyValues)for(var r=0,i=e.keyValues;r<i.length;r++){var a=i[r];t.push(this.buildSQConstantExpr(a))}else t.push(this.buildSQConstantExpr(e.value));return t},r.prototype.getTupleValueExpressions=function(e){for(var t=[],r=0,i=e;r<i.length;r++){var a=i[r];t=t.concat(this.getTupleElementValueExpressions(a))}return t},r.prototype.convertJsonFilterArrayToSemanticFilter=function(e,t){if(!e||_.isEmpty(e))return null;for(var r=[],i=0,a=e;i<a.length;i++){var n=a[i],o=null;if(n.filterType===this.PowerBIModels.FilterType.Tuple)o=this.convertJsonTupleFilterToSemanticFilter(n,t);else{var l={filters:[{name:"Filter"}]},u=this.constructFilterContainer(l,t,n);if(!u)return null;o=u.filter}if(!o)return null;r.push(o)}return s.merge(r)},r.prototype.convertJsonTupleFilterToSemanticFilter=function(e,t){for(var r=this.getTupleTargetExpressions(e.target,t),i=[],a=0,n=e.values;a<n.length;a++){var o=n[a];i.push(this.getTupleValueExpressions(o))}var l=u.inValues(r,i);return s.fromSQExpr(l)},r.prototype.buildBasicFilterContainer=function(r,i,a){var n,o=this.getFieldExpr(i.target,a);o||p.throwException(v.fieldNotFound(i.target));var c;if(i.operator!==l.SelectAll){for(var d=this.getFieldExprsForKeys(i.target,a),f=[],F=0,g=0,y=i.values;g<y.length;g++){var h=y[g],m=[],E=i.keyValues;if(d&&E)for(var x=0,T=E[F];x<T.length;x++){var C=T[x];m.push(this.buildSQConstantExpr(C))}else m.push(this.buildSQConstantExpr(h));f.push(m),F++}var w=u.inValues(d||[o],f),S=void 0;S=i.operator===l.NotIn?u.not(w):w,c=s.fromSQExpr(S)}return n={name:t.FilterUtils.getNextFilterName(r.filters),expression:o,filter:c,type:e.explore.contracts.FilterType.Categorical}},r.prototype.buildAdvancedFilterContainer=function(r,i,a){var n,o=this.getFieldExpr(a.target,i);o||p.throwException(v.fieldNotFound(a.target));for(var u=[],c=0,d=a.conditions;c<d.length;c++){var f=d[c],F=this.getCondition(f);F&&u.push(F)}var g=o.getMetadata(i),y=g?g.type:null,h=l.logicalOperatorDictionary[a.logicalOperator],m=t.viewModels.FilterCardConverter.toSQExpr(o,y,u,h);return m&&(n={name:t.FilterUtils.getNextFilterName(r.filters),expression:o,filter:s.fromSQExpr(m),type:e.explore.contracts.FilterType.Advanced}),n},r.prototype.getCondition=function(t){t||p.throwException(v.filterConditionNotFound());var r,i=l.operatorDictionary[t.operator];return r=_.isString(t.value)&&jsCommon.DateExtensions.parseIsoDateFast(t.value.substr(0,26))?jsCommon.DateExtensions.parseIsoDateFast(t.value.substr(0,26)):t.value,new e.data.Condition(i,r)},r.prototype.getFieldExprsForKeys=function(e,t){var r=this;return e&&e.keys?_.map(e.keys,function(i){return r.getFieldExpr(e,t,i)}):null},r.prototype.getFieldExpr=function(e,t,r){var i,a=t.schemas[0].name;if(r)return u.fieldExpr({column:{schema:a,entity:e.table,name:r}});if(this.PowerBIModels.isMeasure(e)){var n=e;i=u.measureRef(u.entity(a,n.table),n.measure)}else if(this.PowerBIModels.isHierarchy(e)){var o=e;i=u.hierarchyLevel(u.hierarchy(u.entity(a,o.table),o.hierarchy),o.hierarchyLevel)}else if(this.PowerBIModels.isColumn(e)){var l=e;i=u.fieldExpr({column:{schema:a,entity:l.table,name:l.column}})}return i},r.prototype.buildSQConstantExpr=function(t){var r;if(_.isString(t))if(null!=jsCommon.DateExtensions.parseIsoDateFast(t.substr(0,26))){var i=jsCommon.DateExtensions.parseIsoDateFast(t.substr(0,26));r=u.dateTime(i)}else r=u.text(t);else _.isBoolean(t)?r=u.boolean(t):_.isNumber(t)?r=e.Double.isInteger(t)?u.integer(t):u.double(t):p.throwException(v.invalidDataType(t));return r},r.prototype.validateFilter=function(e){return this.PowerBIModels.validateFilter(e)},r}(),v=function(){function e(){}return e.traceError=function(e){c.error("Throwing exception: "+JSON.stringify(e),null==e.Stack)},e.fieldNotFound=function(e){var t=e?"Target table: "+e.table:"";return{name:l.ErrorCodes.FieldNotFound,message:l.ErrorMessages.InvalidTarget+t}},e.filterValidationErrors=function(e){var t=e.map(function(e){return e.message}).join(", ");return{name:l.ErrorCodes.FilterValidationErrors,message:l.ErrorMessages.InvalidFilterMessage+t}},e.invalidDataType=function(e){return{name:l.ErrorCodes.InvalidDataType,message:jsCommon.StringExtensions.format(l.ErrorMessages.InvalidDataTypeMessage,e)}},e.filterConditionNotFound=function(){return{name:l.ErrorCodes.FilterConditionNotFound,message:l.ErrorMessages.InvalidCondition}},e.basicFilterSerializationError=function(e){return{name:l.ErrorCodes.BasicFilterSerializationError,message:l.ErrorMessages.FilterSerializationError+e}},e.advancedFilterSerializationError=function(){return{name:l.ErrorCodes.AdvancedFilterSerializationError,message:l.ErrorMessages.FilterSerializationError}},e.tupleFilterSerializationError=function(e){return{name:l.ErrorCodes.BasicFilterSerializationError,message:l.ErrorMessages.TupleFilterSerializationError+e}},e.invalidFilterType=function(){return{name:l.ErrorCodes.InvalidFilterType,message:l.ErrorMessages.InvalidFilterTypeMessage}},e.invalidFilterCondition=function(){return{name:l.ErrorCodes.InvalidFilterCondition,message:l.ErrorMessages.SemanticFilterInvalidCondition}},e.filterNotFound=function(){return{name:l.ErrorCodes.FilterNotFound,message:l.ErrorMessages.FilterNotFoundMessage}},e.fieldExpressionNotFound=function(){return{name:l.ErrorCodes.FieldNotFound,message:l.ErrorMessages.FieldNotFoundMessage}},e.basicFilterOperatorNotFound=function(){return{name:l.ErrorCodes.BasicFilterOperatorNotFound,message:l.ErrorMessages.BasicFilterOperatorNotFoundMessage}},e.invalidReportData=function(){return{name:l.ErrorCodes.InvalidReportData,message:l.ErrorMessages.InvalidReportDataMessage}},e.invalidPageData=function(){return{name:l.ErrorCodes.InvalidPageData,message:l.ErrorMessages.InvalidPageDataMessage}},e}();i.JsonFilterParserErrors=v}(r=t.jsonFilter||(t.jsonFilter={}))}(t=e.explore||(e.explore={}))}(powerbi||(powerbi={}));var powerbi;!function(e){var t;!function(t){var r;!function(r){var i,a=jsCommon.ArrayExtensions,n=e.explore.viewModels.FilterCardConverter,o=e.explore.jsonFilter.constants,l=jsCommon.Utility,s=e.data.SQExpr,u=e.data.SQExprUtils;!function(i){function a(i,a,n,s,c){var p;if(n&&(!n.conditions()||_.isEmpty(n.conditions())||n.conditions().length>1)&&l.throwException(r.JsonFilterParserErrors.invalidFilterCondition()),u(i))if(i.type===t.contracts.FilterType.TopN)p=v.serializeFilter(n,a,s);else if(i.type===t.contracts.FilterType.RelativeDate)p=F.serializeFilter(n,a,s);else if(i.type===t.contracts.FilterType.Exclude||i.type===t.contracts.FilterType.Include)p=f.serializeFilter(n,a,s);else if(i.type===t.contracts.FilterType.Tuple)p=y.serializeFilter(n,a,s);else{var d=i.expression,m=void 0;if(n){var E=n.conditions()[0];m=h.getAdvancedFilterExpression(E)}var x=i.type;null==x&&(d||l.throwException(r.JsonFilterParserErrors.fieldExpressionNotFound()),x=t.FilterUtils.getDefaultFilterType(d,a,i.howCreated,m?m.field:null)),m&&x===t.contracts.FilterType.Advanced?p=h.serializeFilter(m,a,s):(d||l.throwException(r.JsonFilterParserErrors.fieldExpressionNotFound()),p=g.serializeFilter(n,i,a,s))}else{c.logEvent(e.telemetry.JSONFilterUnsupportedFilterType,t.contracts.FilterType[i.type]);p=new s.NotSupportedFilter(null,o.ErrorMessages.InvalidFilterTypeMessage,t.contracts.FilterType[i.type]).toJSON()}return p}function u(e){return e.type===t.contracts.FilterType.TopN||e.type===t.contracts.FilterType.Exclude||e.type===t.contracts.FilterType.Include||e.type===t.contracts.FilterType.RelativeDate||e.type===t.contracts.FilterType.Categorical||e.type===t.contracts.FilterType.Visual||e.type===t.contracts.FilterType.Advanced||e.type===t.contracts.FilterType.Tuple||!e.type}function c(e,t,r){var i=e.accept(t);return e.hasGroupOnKeys(r)&&(i.keys=d(e,t,r)),i}function d(e,t,r){var i=e.getKeyColumns(r),a=[];return i&&(a=i.map(function(e){return e.accept(t).column})),a}i.fromSemanticFilter=a,i.getTarget=c;var v;!function(t){function i(t,i,a){t||l.throwException(r.JsonFilterParserErrors.filterNotFound());var n=e.data.TopNFilterPattern.extractParametersFromFilter(t);return new a.TopNFilter(c(n.orderByField,new m,i),n.isTop?"Top":"Bottom",n.itemCount).toJSON()}t.serializeFilter=i}(v||(v={}));var f;!function(e){function t(e,t,i){e&&!_.isEmpty(e.conditions())||l.throwException(r.JsonFilterParserErrors.filterNotFound());var a=new p,n=e.conditions()[0].accept(a),o=n[0].fieldExpr,s=n[0].isNot;return new i.IncludeExcludeFilter(c(o,new m,t),s||!1,g.getValuesFromSQExpr(o,t,e).displayedValues).toJSON()}e.serializeFilter=t}(f||(f={}));var F;!function(t){function i(t,i,o){t||l.throwException(r.JsonFilterParserErrors.filterNotFound());var s=e.data.RelativeDateFilterPattern.extractParametersFromSemanticFilter(t),u=s.options,p=new m;return new o.RelativeDateFilter(c(s.field,p,i),a(s.options,o),u.duration,n(s.options,o),(!!u.includeToday)).toJSON()}function a(t,r){if(!t)return null;var i=t.relativeQualifier;return i===e.data.RelativeDateQualifier.Current?r.RelativeDateOperators.InThis:i===e.data.RelativeDateQualifier.Next?r.RelativeDateOperators.InNext:i===e.data.RelativeDateQualifier.Last?r.RelativeDateOperators.InLast:void 0}function n(t,r){if(!t)return null;var i=t.relativeUnit;return i===e.data.RelativeDateUnit.CalendarMonth?r.RelativeDateFilterTimeUnit.CalendarMonths:i===e.data.RelativeDateUnit.CalendarWeek?r.RelativeDateFilterTimeUnit.CalendarWeeks:i===e.data.RelativeDateUnit.CalendarYear?r.RelativeDateFilterTimeUnit.CalendarYears:i===e.data.RelativeDateUnit.Day?r.RelativeDateFilterTimeUnit.Days:i===e.data.RelativeDateUnit.Month?r.RelativeDateFilterTimeUnit.Months:i===e.data.RelativeDateUnit.Week?r.RelativeDateFilterTimeUnit.Weeks:i===e.data.RelativeDateUnit.Year?r.RelativeDateFilterTimeUnit.Years:void 0}t.serializeFilter=i}(F||(F={}));var g;!function(t){function i(e,i,a,n){var s,u=new m,p=c(i.expression,u,a),d=e?t.getOperator(a,e,i.expression):o.SelectAll,v=t.getValuesFromSQExpr(i.expression,a,e,i.cachedValueItems);return s=v.keyValues&&v.keyValues.length>0?new n.BasicFilterWithKeys(p,d,v.displayedValues,v.keyValues):new n.BasicFilter(p,d,v.displayedValues),s||l.throwException(r.JsonFilterParserErrors.basicFilterSerializationError()),s.toJSON()}function a(t,i,a,n){var c={displayedValues:[],keyValues:[]};if(!a)return c;var d,v=s(i,a,t);v&&(d=v.scopeIds),_.isEmpty(d)&&l.throwException(r.JsonFilterParserErrors.basicFilterSerializationError(o.ErrorMessages.FilterValuesNotFound));for(var f=0,F=d;f<F.length;f++){var g=F[f];if(t.hasGroupOnKeys(i)){var y=e.data.SQExprConverter.getAllComparands(g),h=y.map(function(e){return u(e.value)});c.keyValues.push(h),_.isEmpty(n)||n.length!==d.length?l.throwException(r.JsonFilterParserErrors.basicFilterSerializationError(o.ErrorMessages.FilterValuesNotFound)):c.displayedValues=n.map(function(e){return p(e)})}else{var m=e.data.SQExprConverter.getFirstComparandValue(g);c.displayedValues.push(u(m))}}return c}function n(e,t,i){var a=s(e,t,i);return a?a.isNot?"NotIn":"In":void l.throwException(r.JsonFilterParserErrors.basicFilterOperatorNotFound())}function s(t,i,a){var n=a.getKeyColumns(t);return n||l.throwException(r.JsonFilterParserErrors.fieldExpressionNotFound()),e.data.SQExprConverter.asScopeIdsContainer(i,n)}function u(e){return _.isDate(e)?e.toISOString():e}function p(e){var t=e;return null===e?null:"string"==typeof e?e:t&&t.displayName?t.displayName:void l.throwException(r.JsonFilterParserErrors.invalidDataType("Unrecognized type of value: "+e))}t.serializeFilter=i,t.getValuesFromSQExpr=a,t.getOperator=n}(g||(g={}));var y;!function(t){function i(t,i,a){if(!t)return null;var n=null,o=null,u=t.where(),c=u&&u[0]&&u[0].condition;if(!(e.data.SQExpr.isIn(c)&&c.values&&c.args&&c.args.length>1))return null;n=c.args,o=c.values;var p=_.map(n,function(e){var t=e.getTargetColumnRef(i);return{table:t.getTargetEntity().entity,column:t.ref}}),d=_.map(o,function(e){return _.map(e,function(e){if(s.isConstant(e)){return{value:e.value}}l.throwException(r.JsonFilterParserErrors.tupleFilterSerializationError())})}),v=new a.TupleFilter(p,"In",d);return v||l.throwException(r.JsonFilterParserErrors.tupleFilterSerializationError()),v.toJSON()}t.serializeFilter=i}(y||(y={}));var h;!function(t){function i(e,i,a){var n=new m,o=e.field.accept(n),s=t.getAdvancedFilterLogicalOperator(e.logicalOperator),u=e.conditions.map(function(e){return t.getAdvancedFilterCondition(e)}),c=new a.AdvancedFilter(o,s,u);return c||l.throwException(r.JsonFilterParserErrors.advancedFilterSerializationError()),c.toJSON()}function a(e){return n.createAdvFilter(e)}function o(e){switch(e){case 0:return"And";case 1:return"Or";case 2:return"And"}}function s(t){!e.data.OperatorHelper.getValueRequired(t.operator)||t.value&&t.value.hasValue||l.throwException(r.JsonFilterParserErrors.filterConditionNotFound());var i;9===t.operator?i="Is":10===t.operator?i="IsNot":3===t.operator?i="GreaterThan":4===t.operator?i="GreaterThanOrEqual":1===t.operator?i="LessThan":2===t.operator?i="LessThanOrEqual":5===t.operator?i="Contains":6===t.operator?i="DoesNotContain":7===t.operator?i="StartsWith":8===t.operator?i="DoesNotStartWith":11===t.operator?i="IsBlank":12===t.operator?i="IsNotBlank":l.throwException(r.JsonFilterParserErrors.filterConditionNotFound());var a=t.value;return{operator:i,value:t.value.isDate?a.value.toISOString():a.value}}t.serializeFilter=i,t.getAdvancedFilterExpression=a,t.getAdvancedFilterLogicalOperator=o,t.getAdvancedFilterCondition=s}(h||(h={}));var m=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return __extends(r,t),r.prototype.visitEntity=function(e){return{table:e.entity,column:null}},r.prototype.visitHierarchy=function(e){var t=e.arg.accept(this);return t?{table:t.table,hierarchy:e.hierarchy,hierarchyLevel:null}:null},r.prototype.visitAggr=function(t){var r=t.arg.accept(this);if(!r)return null;var i=r;return i.aggregationFunction=e.data.aggregateFunctionName(t.func),i},r.prototype.visitColumnRef=function(e){var t=e.source.accept(this);return t?{table:t.table,column:e.ref}:null},r.prototype.visitMeasureRef=function(e){var t=e.source.accept(this);return t?{table:t.table,measure:e.ref}:null},r.prototype.visitHierarchyLevel=function(e){var t=e.arg.accept(this);return t?{table:t.table,hierarchy:t.hierarchy,hierarchyLevel:e.level}:null},r}(e.data.DefaultSQExprVisitor);i.SemanticFilterFieldVisitor=m}(i=r.JsonFilterBuilder||(r.JsonFilterBuilder={}));var c;!function(e){function t(e,t){for(var r=[],i=function(i,a){var n=_.map(e.values,function(e){return e[i]});r.push({fieldExpr:e.args[i],isNot:t,values:u.concatUnique([],n)})},a=0,n=e.args.length;a<n;a++)i(a,n);return r}function r(e,t){for(var r,i=a.copy(e),n=0,o=t;n<o.length;n++){r=o[n];var l=_.findIndex(i,function(e){return s.equals(e.fieldExpr,r.fieldExpr)&&e.isNot===r.isNot});if(l!==-1){var c=i[l];c.values=u.concatUnique(c.values,r.values)}else i.push(r)}return i}e.fromInExpr=t,e.merge=r}(c||(c={}));var p=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.visitIn=function(e){return c.fromInExpr(e)},t.prototype.visitNot=function(t){return t&&t.arg&&10===t.arg.kind?c.fromInExpr(t.arg,!0):e.prototype.visitNot.call(this,t,void 0)},t.prototype.visitAnd=function(e){var t=e.left.accept(this),r=e.right.accept(this);if(t&&r)return c.merge(t,r)},t}(e.data.DefaultSQExprVisitor)}(r=t.jsonFilter||(t.jsonFilter={}))}(t=e.explore||(e.explore={}))}(powerbi||(powerbi={})),define("JSONFilter/services/jsonFilterParser",["require","exports"],function(e,t){function r(e,t,r){return new s(e,t,r)}Object.defineProperty(t,"__esModule",{value:!0});var i=powerbi,a=i.explore,n=powerbi.explore.viewModels.FilterCardConverter,o=i.data.SemanticFilter,l=a.jsonFilter;t.create=r;var s=function(){function e(e,t,r){this.promiseFactory=e,this.moduleLoader=t,this.telemetryService=r}return e.prototype.tryCreateSemanticFilter=function(e,t,r){return __awaiter(this,void 0,i.Promise,function(){var i,a,n;return __generator(this,function(o){switch(o.label){case 0:return i={filters:[{name:e}]},[4,this.getParser()];case 1:return a=o.sent(),n=a.tryCreateFilterContainer(i,t,r),n?[2,n.filter]:[2]}})})},e.prototype.tryConvertJsonFilterArrayToSemanticFilter=function(e,t){return __awaiter(this,void 0,i.Promise,function(){var r,i;return __generator(this,function(a){switch(a.label){case 0:return[4,this.getParser()];case 1:return r=a.sent(),i=r.tryConvertJsonFilterArrayToSemanticFilter(e,t),[2,i]}})})},e.prototype.tryCreateJSONFilter=function(e,t){return __awaiter(this,void 0,i.Promise,function(){var r,l,s,u,c,p,d,v,f,F,g,y,h;return __generator(this,function(m){switch(m.label){case 0:return[4,this.getParser()];case 1:if(r=m.sent(),l=o.unmerge(e),_.isEmpty(l))return[2,[]];for(s=[],u=0,c=l;u<c.length;u++){if(p=c[u],d={name:"filter",filter:p},v=!1,v||(f=i.data.TopNFilterPattern.extractParametersFromFilter(p),f&&(d.type=a.contracts.FilterType.TopN,v=!0)),v||(F=i.data.RelativeDateFilterPattern.extractParametersFromSemanticFilter(p),F&&(d.type=a.contracts.FilterType.RelativeDate,v=!0)),v||(g=i.data.TupleFilterPattern.extractParametersFromFilter(p),g&&(d.type=a.contracts.FilterType.Tuple,v=!0)),v||(y=n.createAdvFilter(p.conditions()[0]),y&&(d.type=powerbi.explore.FilterUtils.getFilterType(y.field,y.supportsCategorical),d.expression=y.field,v=!0)),!v)return[2,null];s.push(d)}return h={filters:s},[4,r.tryGetFilters(h,t)];case 2:return[2,m.sent()]}})})},e.prototype.tryCreateFilterContainer=function(e,t,r){return __awaiter(this,void 0,i.Promise,function(){var i;return __generator(this,function(a){switch(a.label){case 0:return[4,this.getParser()];case 1:return i=a.sent(),[4,i.tryCreateFilterContainer(e,t,r)];case 2:return[2,a.sent()]}})})},e.prototype.tryGetFilters=function(e,t){return __awaiter(this,void 0,i.Promise,function(){var r;return __generator(this,function(i){switch(i.label){case 0:return[4,this.getParser()];case 1:return r=i.sent(),[4,r.tryGetFilters(e,t)];case 2:return[2,i.sent()]}})})},e.prototype.tryGetSelectedDataPoints=function(e,t,r,a,n){return __awaiter(this,void 0,i.Promise,function(){var i;return __generator(this,function(o){switch(o.label){case 0:return[4,this.getParser()];case 1:return i=o.sent(),[4,i.tryGetSelectedDataPoints(e,t,r,a,n)];case 2:return[2,o.sent()]}})})},e.prototype.getParser=function(){return __awaiter(this,void 0,i.Promise,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return this.parser?[3,2]:(e=this,[4,l.createJSONFilterParserService(this.promiseFactory,this.moduleLoader,this.telemetryService)]);case 1:e.parser=t.sent(),t.label=2;case 2:return[2,this.parser]}})})},e}()});var powerbi;!function(e){var t;!function(t){function r(r,a,o,l,s,u,c,p,d,v,f,F,g){var y=t.CustomerAction(a,o,l,s,u,c,p,d,v,f,F,g),h=n(y.info,{filterType:r});return{name:"PBI.JSONFilter.UnsupportedFilterType",category:e.TelemetryCategory.CustomerAction,time:Date.now(),id:i(),formatted:function(){return e.extendFormatted({filterType:h.filterType},null,y.formatted())},info:h,loggers:t.JSONFilterUnsupportedFilterTypeLoggers}}var i,a=jsCommon.Utility,n=jsCommon.UnionExtensions.mergeUnionType;i=a?a.generateGuid:Function.prototype,t.JSONFilterUnsupportedFilterType=r}(t=e.telemetry||(e.telemetry={}))}(powerbi||(powerbi={}));