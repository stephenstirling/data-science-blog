"use strict";define("ShapeMapVisual/shapeMap/shapeMap",["require","exports","ShapeMapVisual/shapeMap/shapeMapBehaviors","topojson"],function(e,t,o,a){Object.defineProperty(t,"__esModule",{value:!0});var i;t.ShapeMapBehavior=o.ShapeMapBehavior;var r=powerbi.visuals,s=r.ColorHelper,n=powerbi.data.DataRoleHelper,l=powerbi.DataViewObjects,h=powerbi.GeoJsonTypes,p=r.Legend,c=r.ShapeMapType,u=c.Role,d=c.Projection,m=r.SelectionIdBuilder,v=r.standardGeoJson,g=r.TooltipBuilder,f=(i={},i[v.australiaStates]={projections:[d.mercator,d.equirectangular,d.orthographic]},i[v.austriaStates]={projections:[d.mercator,d.equirectangular,d.orthographic]},i[v.brazilStates]={projections:[d.orthographic,d.equirectangular,d.mercator]},i[v.canadaProvinces]={projections:[d.orthographic,d.equirectangular,d.mercator]},i[v.franceRegions]={projections:[d.orthographic,d.equirectangular,d.mercator]},i[v.germanyStates]={projections:[d.orthographic,d.equirectangular,d.mercator]},i[v.irelandCounties]={projections:[d.orthographic,d.equirectangular,d.mercator]},i[v.italyRegions]={projections:[d.mercator,d.equirectangular,d.orthographic]},i[v.mexicoStates]={projections:[d.orthographic,d.equirectangular,d.mercator]},i[v.netherlandsProvinces]={projections:[d.mercator,d.equirectangular,d.orthographic]},i[v.ukCountries]={projections:[d.orthographic,d.equirectangular,d.mercator]},i[v.usaStates]={projections:[d.albersUsa,d.equirectangular,d.mercator,d.orthographic]},i),y=[d.mercator,d.equirectangular,d.orthographic],w="backgroundNeutral",M="foregroundNeutralSecondaryAlt2",S=function(){function e(e){this.resetToDefault=!1,e&&(this.behavior=e.behavior,this.behavior&&(this.behavior.shapeMap=this),this.tooltipsEnabled=e.tooltipsEnabled)}return e.prototype.init=function(e){this.root=e.element,this.hostServices=e.host,this.tooltipService=r.createTooltipService(e.host),this.viewport=e.viewport,this.svg=d3.select(this.root.get(0)).append("svg").attr("class","shapeMap").attr("width",this.viewport.width).attr("height",this.viewport.height).attr("drag-resize-disabled","true").style("position","absolute"),this.behavior&&(this.clearCatcher=r.appendClearCatcher(this.svg),this.interactivityService=r.createInteractivityService(this.hostServices)),this.mapG=this.svg.append("g"),this.style=e.style,this.legend=r.createLegend(this.root,e.interactivity&&e.interactivity.isInteractiveLegend,this.interactivityService,!0,void 0,this.style,this.hostServices)},e.prototype.update=function(t){if(this.viewport=t.viewport,!_.isEmpty(t.dataViews)&&t.dataViews[0]){var o=this.dataView=t.dataViews[0];this.viewModel=e.converter(o,this.style,this.interactivityService,this.tooltipsEnabled),this.render(null==t.resizeMode||t.isInFocus,t.suppressAnimations)}},e.prototype.enumerateObjectInstances=function(t){if(this.viewModel){var o=new r.ObjectEnumerationBuilder;switch(t.objectName){case"legend":if(!this.viewModel.hasDynamicSeries)return;p.enumerate({enumeration:o,legendData:this.viewModel.legendData});break;case"shape":this.viewModel.shapeMap?o.pushInstance({objectName:"shape",selector:null,properties:{map:_.clone(this.viewModel.shapeMap),projectionEnum:this.viewModel.projectionEnum},validValues:{projectionEnum:e.validProjectionsForShapeMap(this.viewModel.shapeMap)}}):o.pushInstance({objectName:"shape",selector:null,properties:{map:{}},validValues:{projectionEnum:y}});break;case"zoom":o.pushInstance({objectName:"zoom",selector:null,properties:{autoZoom:this.viewModel.autoZoom,selectionZoom:this.viewModel.selectionZoom,manualZoom:this.viewModel.manualZoom}});break;case"defaultColors":o.pushInstance({objectName:"defaultColors",selector:null,properties:{defaultShow:this.viewModel.defaultShow,defaultColor:this.viewModel.defaultShow?this.viewModel.defaultColor:null,borderColor:this.viewModel.borderColor,borderThickness:this.viewModel.borderThickness}});break;case"dataPoint":e.shouldEnumerateDataPoints(this.dataView)&&e.enumerateDataPoints(o,this.viewModel,this.dataView,this.style)}return o.complete()}},e.getStandardGeoJsonFiles=function(){return _.clone(f)},e.validProjectionsForShapeMap=function(e){if(!e||!e.name)return y;var t=f[e.name];return!t||_.isEmpty(t.projections)?y:t.projections},e.shouldEnumerateDataPoints=function(e){return!!n.hasRoleInDataView(e,c.Role.series)||!n.hasRoleInDataView(e,c.Role.value)},e.enumerateDataPoints=function(e,t,o,a){t&&(t.hasDynamicSeries?powerbi.requireSync("PowerBIVisuals/Visuals/common/colorEnumerationHelper").enumerateSeriesDataColors({enumeration:e,dataPoints:powerbi.visuals.LegendData.toIEnumerableDataPoints(t.legendData)}):powerbi.requireSync("PowerBIVisuals/Visuals/common/colorEnumerationHelper").enumerateCategoryDataColors({enumeration:e,dataView:o,style:a,dataPoints:_.map(t.dataPoints,function(e){return{displayName:e.location,color:e.color,identity:e.identity}})}))},e.prototype.getDataPointFromShape=function(e){return this.matcher.getDataPointFromShape(e)},e.getObjectProperties=function(t,o){var a=t&&t.metadata&&t.metadata.objects?t.metadata.objects:{},i=r.shapeMapProps,n=l.getValue(a,i.shape.map,null),h=e.validProjectionsForShapeMap(n),p=h[0],c=l.getValue(a,i.shape.projectionEnum,p);_.includes(h,c)||(c=p);var u=s.create(o);return{map:n,projectionEnum:c,autoZoom:l.getValue(a,i.zoom.autoZoom,!1),selectionZoom:l.getValue(a,i.zoom.selectionZoom,!1),manualZoom:l.getValue(a,i.zoom.manualZoom,!1),defaultShow:l.getValue(a,i.defaultColors.defaultShow,!0),defaultColor:u.getColorForProperty(a,i.defaultColors.defaultColor,w),borderColor:u.getColorForProperty(a,i.defaultColors.borderColor,M),borderThickness:l.getValue(a,i.defaultColors.borderThickness,1)}},e.converter=function(t,o,a,i){void 0===i&&(i=!0);var s,n,l,h,c,d,v,f=[],y=0;t&&(s=powerbi.data.createDataViewCategoricalReaderAdvanced(t,{colorOptions:{valueRole:u.value,visualStyle:o}}),n=s.data,l=s.columns,h=n.getValueQueryName(u.value),c=n.getCategoryDisplayName(u.category),d=l.getCategoryMetadataColumn(u.category),v=l.getCategoryColumn(u.category));var w,M=!1,S=!1,C=!1;s&&(M=l.hasDynamicSeries(),S=n.hasValues(u.value),C=n.hasCategoryWithRole(u.category),w=n.getValueQueryName(u.value),null==w&&(w=""));var j=t&&s&&n.hasCategories();if(j){var b=r.shapeMapProps.general.formatString;y=n.getSeriesCount();for(var P=0;P<n.getCategoryCount();P++){var D=n.getValue(u.value,P),Z=void 0,V=void 0,N=void 0,E=void 0;C&&(Z=n.getCategoryValue(u.category,P),V={displayName:n.getCategoryDisplayName(u.category),value:r.converterHelper.formatFromMetadataColumn(Z,l.getCategoryMetadataColumn(u.category),b)}),y=n.getSeriesCount(),n.hasValues(u.value)||(y=1);for(var F=(new m).withCategory(l.getCategoryColumn(u.category),P).withMeasure(n.getValueQueryName(u.value)),T=F.createSelectionId(),I=0;I<y;I++){var k=void 0;k=s.colors.createBySeries(I,P);var q=(new m).withCategory(l.getCategoryColumn(C?u.category:u.value),P).withMeasure(n.getValueQueryName(u.value));M&&(q=q.withSeries(l.getSeriesValueColumns(),l.getValueColumn(u.value,I)),N={displayName:n.getSeriesDisplayName(),value:r.converterHelper.formatFromMetadataColumn(n.getSeriesName(I),l.getSeriesMetadataColumn(),b)}),S&&(D=n.getValue(u.value,P,I),E={displayName:n.getValueDisplayName(u.value),value:r.converterHelper.formatFromMetadataColumn(D,l.getValueMetadataColumn(u.value,I),b,!1)});var z=[];i&&(V&&z.push(V),N&&z.push(N),E&&z.push(E),g.addTooltipMeasures(s,z,P,I,b)),null==D&&S||f.push({location:Z,identity:q.createSelectionId(),value:D,selected:!1,tooltipInfo:z,color:k,categoryIdentity:T})}}}a&&a.applySelectionStateToData(f);var O=e.getObjectProperties(t,o);return{shapeMap:O.map,projectionEnum:O.projectionEnum,autoZoom:O.autoZoom,selectionZoom:O.selectionZoom,manualZoom:O.manualZoom,defaultShow:O.defaultShow,defaultColor:O.defaultColor,borderColor:O.borderColor,borderThickness:O.borderThickness,dataPoints:f,categoryName:c,dataAvailable:j,hasDynamicSeries:M,seriesCount:y,legendData:p.buildSeriesLegendData({dataView:t,showByDefault:!0,style:o})}},e.createProjection=function(e){var t=d3.geo[e]();return e===d.orthographic&&t.clipAngle(90),t},e.adjustProjection=function(e,t,o,a,i,r){if(void 0===r&&(r=1),e.scale(1).translate([0,0]),t>0){var s=d3.geo.centroid(i);e.rotate(s.map(function(e,o){return o<t?-e:0}))}var n=d3.geo.path().projection(e).bounds(i),l=n[0][0],h=n[1][0],p=n[0][1],c=n[1][1],u=Math.abs(h-l),d=Math.abs(c-p),m=Math.min(o/u,a/d);m*=r,e.scale(m);var v=(o-m*(h+l))/2,g=(a-m*(c+p))/2;e.translate([v,g])},e.prototype.createGetColorFunction=function(){var e=this;return function(t){var o=e.matcher.getDataPointFromShape(t);return o&&null!=o.color?o.color:e.viewModel.defaultColor}},e.rotationAxes=function(e){switch(e){case d.albersUsa:return 0;case d.mercator:case d.equirectangular:return 1;case d.orthographic:return 2;default:return 0}},e.prototype.zoomOnClick=function(e){this.viewModel&&this.viewModel.selectionZoom&&(!e&&this.selectionZoomShape||e&&e.id&&this.selectionZoomShape&&this.selectionZoomShape.id&&this.selectionZoomShape.id===e.id?this.selectionZoomShape=null:this.selectionZoomShape=e,this.render(!1,!1,!0))},e.prototype.resetToDefaultMap=function(){var t={type:h.shared,name:v.usaStates,content:void 0},o=c.Projection.albersUsa;this.hostServices.persistProperties([{objectName:"shape",selector:null,properties:{map:t,projectionEnum:o},validValues:{projectionEnum:e.validProjectionsForShapeMap(t)}}])},e.loadFeatureCollection=function(e){if(_.isEmpty(e.objects))return{features:[],type:"FeatureCollection"};for(var t in e.objects)return a.feature(e,e.objects[t])},e.prototype.featuresToZoomTo=function(e,t){var o=this;if(t&&this.selectionZoomShape)return{type:"FeatureCollection",features:[this.selectionZoomShape]};if(this.viewModel.autoZoom){var a={type:"FeatureCollection",features:e.features.filter(function(e){return!!o.getDataPointFromShape(e)})};if(a.features.length>0)return a}return e},e.prototype.render=function(t,o,a){var i=this;if(!this.viewModel.shapeMap||!this.viewModel.shapeMap.content)return void(this.resetToDefault||(this.resetToDefault=!0,this.resetToDefaultMap()));this.resetToDefault=!1,this.mapG.transition(),this.shapes&&this.shapes.transition(),this.shapes&&this.shapes.exit()&&this.shapes.exit().transition(),this.manualZoomDisconnect(),this.viewModel.projectionEnum!==this.projectionEnum&&(this.projection=null),this.projectionEnum=this.viewModel.projectionEnum,this.renderLegend(t),p.positionChartArea(this.svg,this.legend);var r=this.getMapViewport();this.svg.attr("width",r.width).attr("height",r.height);var s=JSON.parse(this.viewModel.shapeMap.content),n=e.loadFeatureCollection(s);this.matcher=new C.Matcher(n.features,this.viewModel.dataPoints,this.viewModel.categoryName);var l=this.featuresToZoomTo(n,a),h=this.projection&&!this.viewModel.autoZoom&&!this.viewModel.selectionZoom&&this.prevAutoZoom===this.viewModel.autoZoom&&this.prevManualZoom===this.viewModel.manualZoom&&this.prevSelectionZoom===this.viewModel.selectionZoom&&this.prevShapeMapName===this.viewModel.shapeMap.name&&this.prevMapViewportWidth===r.width&&this.prevMapViewportHeight===r.height;this.prevAutoZoom=this.viewModel.autoZoom,this.prevManualZoom=this.viewModel.manualZoom,this.prevSelectionZoom=this.viewModel.selectionZoom,this.prevShapeMapName=this.viewModel.shapeMap.name,this.prevMapViewportWidth=r.width,this.prevMapViewportHeight=r.height;var c;if(h)c=this.projection;else{c=e.createProjection(this.viewModel.projectionEnum);var u=e.rotationAxes(this.viewModel.projectionEnum);e.adjustProjection(c,u,r.width,r.height,l,.9)}var d=this.createGetColorFunction();if(this.mapG.style("stroke-width",this.viewModel.borderThickness/2).style("stroke",this.viewModel.borderColor).style("fill",this.viewModel.defaultColor),this.shapes=this.mapG.selectAll("path").data(this.visibleFeatures(n),this.shapeKeyFunction(n)),!this.projection||o)this.projection=c,this.path=d3.geo.path().projection(this.projection),this.shapes.enter().append("path"),this.shapes.attr("d",this.path).style("fill",d).attr("opacity",1),this.shapes.exit().remove(),this.manualZoomConnect();else{var m=600;if(this.path=d3.geo.path().projection(this.projection),this.shapes.enter().append("path").style("fill",d).attr("opacity",0).attr("d",this.path),this.shapes.transition().duration(m).style("fill",d).attr("opacity",1),this.shapes.exit().transition().duration(m).style("fill",d).attr("opacity",0).remove(),e.projectionsEqual(this.projection,c))this.projection=c,this.shapes.attr("d",this.path),this.shapes.exit().attr("d",this.path),this.manualZoomConnect();else{var v=this.projection,g=c;this.mapG.transition().duration(m).tween("projection transition",function(){var e=v.scale&&d3.interpolate(v.scale(),g.scale()),t=v.translate&&d3.interpolate(v.translate(),g.translate()),o=v.rotate&&d3.interpolate(v.rotate(),g.rotate());return v=null,g=null,function(a){e&&i.projection.scale(e(a)),t&&i.projection.translate(t(a)),o&&i.projection.rotate(o(a)),i.shapes.attr("d",i.path),i.shapes.exit().attr("d",i.path)}}).each("end",function(){return i.manualZoomConnect()})}}if(this.tooltipsEnabled){var f=[];this.viewModel.dataAvailable||(f=this.matcher.shapeProps.map(function(e){return e.propName}).sort()),this.tooltipService.addTooltip(this.shapes,function(e){if(i.viewModel.dataAvailable){if(!e.data)return;var t=i.matcher.getDataPointFromShape(e.data);return t?t.tooltipInfo:[{displayName:i.viewModel.categoryName,value:""+i.matcher.getShapeProp(e.data,i.matcher.shapePropName)||""}]}return f.map(function(t){return{displayName:t?t:"ID",value:""+i.matcher.getShapeProp(e.data,t)}})},function(e){var t=e.data&&i.matcher.getDataPointFromShape(e.data);if(t)return t.identity})}if(this.behavior&&this.interactivityService){var y={shapes:this.shapes,clearCatcher:this.clearCatcher};this.interactivityService.bind(this.viewModel.dataPoints,this.behavior,y)}},e.prototype.visibleFeatures=function(e){var t=this;return this.viewModel.defaultShow?e.features:e.features.filter(function(e){return!!t.getDataPointFromShape(e)})},e.prototype.shapeKeyFunction=function(e){return e.features[0]&&null!=e.features[0].id?function(e){return e.id}:null},e.projectionsEqual=function(e,t){return!(e.scale&&!_.isEqual(e.scale(),t.scale()))&&(!(e.rotate&&!_.isEqual(e.rotate(),t.rotate()))&&!(e.translate&&!_.isEqual(e.translate(),t.translate())))},e.prototype.manualZoomConnect=function(){var e=this;if(!this.zoom&&this.viewModel.manualZoom){var t=this.projection.scale();this.zoom=d3.behavior.zoom().translate(this.projection.translate()).scale(t).scaleExtent([t/4,t*16]),this.zoom.on("zoom",function(){e.projection.translate(e.zoom.translate()).scale(e.zoom.scale()),e.shapes.attr("d",e.path)}),this.svg.call(this.zoom)}},e.prototype.manualZoomDisconnect=function(){this.zoom&&this.zoom.on("zoom",null),this.zoom=null},e.prototype.getMapViewport=function(){var e=this.viewport,t=this.legend.getMargins();return{width:e.width-t.width,height:e.height-t.height}},e.prototype.renderLegend=function(e){var t=this.viewModel.legendData;null!=t.position&&this.legend.changeOrientation(t.position),1===t.dataPoints.length&&!t.grouped&&!this.viewModel.hasDynamicSeries&&(t.dataPoints=[]),this.legend.drawLegend(t,this.viewport,e)},e.prototype.onClearSelection=function(){this.interactivityService&&this.interactivityService.clearSelection()},e.prototype.onRestoreSelection=function(e){return!!this.interactivityService&&this.interactivityService.restoreSelection(e.selection)},e}();t.ShapeMap=S;var C;!function(e){var t=function(){function e(e,t,o){this.shapes=e,this.dataPoints=t,this.categoryName=o,this.shapeProps=this.countShapeProps(this.shapes),this.shapeProps=this.shapeProps.sort(this.getShapePropCompareFunction(this.categoryName)),this.buildMappings()}return e.prototype.getDataPointFromShape=function(e){var t=this.getShapeProp(e,this.shapePropName);return t||0===t?this.shapeToData[t]:null},e.prototype.getShapeFromDataPoint=function(e){var t=e.location;return this.dataToShape[t]},e.prototype.countShapeProps=function(e){for(var t={},o=0,a=e.length,i=0;i<a;i++){var r=e[i];r.hasOwnProperty("id")&&o++;for(var s in r.properties)t.hasOwnProperty(s)?t[s]++:t[s]=1}var n=[];for(var s in t)t.hasOwnProperty(s)&&n.push({propName:s,count:t[s]});return o>0&&n.push({propName:"",count:o}),n},e.prototype.getShapePropCompareFunction=function(e){return function(t,o){if(t.count!==o.count)return o.count-t.count;if(e){if(t.propName===e)return-1;if(o.propName===e)return 1;if(e=e.toLowerCase().trim(),t.propName.toLowerCase().trim()===e)return-1;if(o.propName.toLowerCase().trim()===e)return 1}return 0}},e.prototype.getShapeProp=function(e,t){return""===t?e.id:e.properties[t]},e.prototype.removeAtIndex=function(e,t){return e.slice(0,t).concat(e.slice(t+1))},e.prototype.buildMappings=function(){var e=0;e:for(var t=0,o=this.shapeProps;t<o.length;t++){var a=o[t];if(e>a.count)break e;for(var i=0,r={},s={},n=this.shapes,l=this.dataPoints,h=n.length-1;h>=0;h--){var p=n[h],c=this.getShapeProp(p,a.propName);if(c||0===c){t:for(var u=0;u<l.length;u++){var d=l[u],m=d.location;if(null!=m&&(m===c||m.toLowerCase&&c.toLowerCase&&m.toLowerCase()===c.toLowerCase())){r[m]=p,s[c]=d,n=this.removeAtIndex(n,h),l=this.removeAtIndex(l,u),i++;break t}}if(0===n.length||0===l.length){e=i,this.shapePropName=a.propName,this.shapeToData=s,this.dataToShape=r;break e}}}i>e&&(e=i,this.shapePropName=a.propName,this.shapeToData=s,this.dataToShape=r)}},e}();e.Matcher=t}(C=t.Matching||(t.Matching={}))}),define("ShapeMapVisual/shapeMap/shapeMapBehaviors",["require","exports"],function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var o=jsCommon.BrowserUtils,a=powerbi.visuals,i=a.InteractivityUtils,r=function(){function e(){}return e.prototype.bindEvents=function(e,t){var r=this;e.clearCatcher.on("click",function(){o.isCtrlOrMeta(d3.event)||t.handleClearSelection(),r.shapeMap.zoomOnClick()}),this.shapes=e.shapes,this.shapes.on("click",function(e,a){var s=r.shapeMap.getDataPointFromShape(e);if(s){var n=i.getPositionOfLastInputEvent();t.handleSelection({identity:s.categoryIdentity,selected:s.selected},o.isCtrlOrMeta(d3.event),n)}else t.handleClearSelection();r.shapeMap.zoomOnClick(e)}),this.shapes.on("contextmenu",function(){if(!o.isCtrlOrMeta(d3.event)){d3.event.preventDefault(),a.EventBubblingUtil.markAsHandled(d3.event);var e=d3.event.target,s=d3.select(e).datum();if(s){var n=r.shapeMap.getDataPointFromShape(s);if(n){var l=i.getPositionOfLastInputEvent();t.handleContextMenu(n,l)}}}})},e.prototype.renderSelection=function(e){var t=this;this.shapes.transition().duration(600).style("opacity",function(o){var a=t.shapeMap.getDataPointFromShape(o);return a&&a.selected||!e?1:.4})},e}();t.ShapeMapBehavior=r});